@page "/state/create"
@page "/state/edit/{CountryCode}/{StateID}"
@using DevShop.Data
@inject IUnitOfWork uow
@inject NavigationManager nav
@attribute [Authorize(Roles = "7")]
@layout ManagementLayout



<h1>States</h1>
@if (countries != null)
{
    @if (countries.Count > 0)
    {
        <select @onchange="@((e) => ChangeCountry(e))">
            <option value="0">Please select a country</option>
            @foreach (var _country in countries)
            {
                @if (isEdit && country != null && _country.CountryCode == country.CountryCode)
                {
                    <option value="@_country.CountryCode" selected>@_country.CountryName</option>
                }
                else
                {
                    <option value="@_country.CountryCode">@_country.CountryName</option>
                }
            }
        </select>
        @if (dropDownStates != null && dropDownStates.Count > 0)
        {
            <br /><br />
            <select @onchange="@((e) => ChangeState(e))">
                @foreach (var _state in dropDownStates)
                {
                    @if (isEdit && state != null && Convert.ToInt32(_state.Value) == state.StateId)
                    {
                        <option value="@_state.Value" selected>@_state.DisplayName</option>
                    }
                    else
                    {
                        <option value="@_state.Value">@_state.DisplayName</option>
                    }
                }
            </select>
        }
        <br><br />
        <EditForm Model="state" OnValidSubmit="Save" OnInvalidSubmit="Error">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <b>@errorMessage</b>
                <br /><br />
            }
            <input type="text" placeholder="Tyrol" maxlength="150" pattern="*{5,}" @bind="state.StateName"><br>
            <select @onchange="@((e) => SetCountry(e))">
                @foreach (var _country in countries)
                {
                    @if (_country.CountryCode == selCountry.CountryCode)
                    {
                        <option value="@_country.CountryCode" selected>@_country.CountryName</option>
                    }
                    else
                    {
                        <option value="@_country.CountryCode">@_country.CountryName</option>
                    }
                }
            </select>
            <br><br>
            <input type="submit" value="Save">
            @if(isEdit)
            {
                <input type="button" value="Delete" @onclick="@(() => Delete())"/>
            }
            <br><br>
            <a href="./state/create">
                Create a new state
            </a>
        </EditForm>
    }
    else
    {
        <div>
            No country has been found.<br>
            Click <a href="./country/create">here</a> to create a country before proceeding.
        </div>
    }
}
else
{
    <span>
        Loading ...
    </span>
}